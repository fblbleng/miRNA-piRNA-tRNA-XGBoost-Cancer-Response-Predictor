---
title: "RNA Data Preprocessing Pipeline"
author: "Fabiola Blengio"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(readr)
library(scales)
library(tibble)
```

1. Load Datasets

# Load RNA CSVs
load_rna_csv <- function(path) {
  df <- read_csv(path)
  rownames(df) <- df[[1]]
  df <- df[, -1]
  return(df)
}

mirna <- load_rna_csv("data/mirna.csv")
pirna <- load_rna_csv("data/pirna.csv")
trna  <- load_rna_csv("data/trna.csv")

# Preview
head(mirna[, 1:5])

2. Merge by Patient ID

merge_rna_data <- function(m1, p1, t1) {
  common_ids <- Reduce(intersect, list(rownames(m1), rownames(p1), rownames(t1)))
  merged <- cbind(m1[common_ids, ], p1[common_ids, ], t1[common_ids, ])
  return(merged)
}

merged_rna <- merge_rna_data(mirna, pirna, trna)
dim(merged_rna)

3. Normalize Features (Z-score)

normalize_zscore <- function(df) {
  return(as.data.frame(scale(df)))
}

X <- normalize_zscore(merged_rna)
summary(X[, 1:5])

4. Load Metadata and Extract Response

metadata <- read_csv("data/metadata.csv")

extract_labels <- function(meta_df, ids) {
  filtered <- meta_df %>% filter(patient_id %in% ids)
  labels <- filtered$response
  names(labels) <- filtered$patient_id
  return(labels[ids])
}

y <- extract_labels(metadata, rownames(X))
table(y)

5. Export Preprocessed Data

write.csv(X, "results/preprocessed_features.csv", row.names = TRUE)
write.csv(data.frame(patient_id = names(y), response = y), 
          "results/response_labels.csv", row.names = FALSE)
